<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unidade - Insightflow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- XLSX.js -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-white min-h-screen">
    <div class="flex min-h-screen w-full">
        
        <!-- Sidebar (mesma estrutura) -->
        <aside id="sidebar" class="w-56 bg-white flex flex-col border-r border-gray-200">
            <div class="p-6">
                <h1 class="text-xl font-bold text-gray-800">Relat√≥rios</h1>
            </div>

            <nav class="flex-1 px-3">
                <a href="#" id="telaInicialLink" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                    <i class="fas fa-home"></i>
                    <span>Tela Inicial</span>
                </a>

                <a href="#" id="unidadesLink" class="flex items-center gap-3 px-4 py-3 rounded-lg bg-blue-50 text-blue-600 border-l-4 border-blue-600 transition-colors">
                    <i class="fas fa-building"></i>
                    <span>Unidades</span>
                </a>

                <a href="conexoes.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                    <i class="fas fa-plug"></i>
                    <span>Conex√µes</span>
                </a>

                <a href="minha-conta.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                    <i class="fas fa-user"></i>
                    <span>Minha Conta</span>
                </a>

                <a href="usuarios.html" id="adminLink" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors hidden">
                    <i class="fas fa-users"></i>
                    <span>Usu√°rios</span>
                </a>

                <a href="analises-predefinidas.html" id="analysisLink" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors hidden">
                    <i class="fas fa-comments"></i>
                    <span>An√°lises Pr√©-Definidas</span>
                </a>
            </nav>

            <div class="p-4 border-t border-gray-200">
                <button id="logoutBtn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sair</span>
                </button>
            </div>
        </aside>

        <!-- Conte√∫do Principal -->
        <main class="flex-1 p-8 overflow-auto">
            <div class="max-w-4xl mx-auto">
                
                <!-- Breadcrumb -->
                <div class="mb-6">
                    <a href="#" id="backLink" class="text-blue-600 hover:text-blue-700 flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i>
                        <span>Voltar para Unidades</span>
                    </a>
                </div>

                <!-- Header -->
                <div class="mb-8">
                    <h1 id="unitTitle" class="text-3xl font-bold text-gray-900 mb-2">
                        <i class="fas fa-building text-blue-600"></i>
                        <span id="unitName">Carregando...</span>
                    </h1>
                </div>

                <!-- Dashboard da Unidade -->
                <div id="dataCards" class="grid grid-cols-3 gap-6 mb-8 hidden">
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6">
                        <div class="text-sm text-gray-600 mb-1">üìã Or√ßamentos</div>
                        <div id="totalBudgets" class="text-3xl font-bold text-blue-600">-</div>
                    </div>
                    <div class="bg-green-50 border-2 border-green-200 rounded-xl p-6">
                        <div class="text-sm text-gray-600 mb-1">‚úÖ Vendas</div>
                        <div id="totalSales" class="text-3xl font-bold text-green-600">-</div>
                    </div>
                    <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-6">
                        <div class="text-sm text-gray-600 mb-1">üí∞ Faturamento</div>
                        <div id="totalRevenue" class="text-3xl font-bold text-purple-600">-</div>
                    </div>
                </div>

                <!-- Importar Planilha -->
                <div class="bg-white border-2 border-gray-200 rounded-xl p-6 mb-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-file-excel text-green-600"></i>
                        Importar Planilha de Or√ßamentos
                    </h2>
                    
                    <div id="dropZone" 
                         class="border-4 border-dashed border-gray-300 rounded-xl p-12 text-center hover:border-blue-400 hover:bg-blue-50 transition-colors cursor-pointer">
                        <div class="text-6xl mb-4">üì•</div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">
                            Arraste a planilha aqui
                        </h3>
                        <p class="text-gray-600 mb-4">
                            ou clique para selecionar
                        </p>
                        <p class="text-sm text-gray-500">
                            Formatos aceitos: .xlsx, .xls | Tamanho m√°ximo: 10MB
                        </p>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden">
                    </div>

                    <div id="fileInfo" class="mt-4 hidden bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-file-excel text-2xl text-green-600"></i>
                            <div class="flex-1">
                                <p id="fileName" class="font-semibold text-gray-900"></p>
                                <p id="fileDate" class="text-sm text-gray-600"></p>
                            </div>
                        </div>
                        
                        <!-- Per√≠odos sem dados -->
                        <div id="missingPeriodsContainer" class="mt-4 hidden">
                            <div class="flex items-start gap-2 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-yellow-800 mb-1">‚ö†Ô∏è Per√≠odos sem dados:</p>
                                    <ul id="missingPeriodsList" class="text-sm text-yellow-700 space-y-1">
                                        <!-- Preenchido dinamicamente -->
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div id="noDuplicatesContainer" class="mt-4 hidden">
                            <div class="flex items-center gap-2 text-sm text-green-700">
                                <i class="fas fa-check-circle"></i>
                                <span>‚úÖ Sem per√≠odos faltando</span>
                            </div>
                        </div>
                    </div>

                    <div id="uploadProgress" class="mt-4 hidden">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-gray-700">Processando planilha...</span>
                            <span id="progressPercent" class="text-sm text-gray-600">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Configura√ß√µes de Filtro -->
                <div class="bg-white border-2 border-gray-200 rounded-xl p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-filter text-blue-600"></i>
                        Configura√ß√µes de Filtro
                    </h2>
                    
                    <div class="space-y-4 mb-6">
                        <div>
                            <h3 class="font-semibold text-gray-900 mb-3">Fontes de Tr√°fego Pago</h3>
                            <div class="space-y-2">
                                <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="cbFacebook" class="w-5 h-5 text-blue-600">
                                    <i class="fab fa-facebook text-blue-600"></i>
                                    <span>Facebook</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="cbInstagram" class="w-5 h-5 text-pink-600">
                                    <i class="fab fa-instagram text-pink-600"></i>
                                    <span>Instagram</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="cbGoogle" class="w-5 h-5 text-red-600">
                                    <i class="fab fa-google text-red-600"></i>
                                    <span>Google Ads</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="cbRevista" class="w-5 h-5 text-gray-600">
                                    <i class="fas fa-book text-gray-600"></i>
                                    <span>Revista (campanhas black)</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="cbEmpty" class="w-5 h-5 text-gray-400">
                                    <i class="fas fa-ban text-gray-400"></i>
                                    <span>(Vazias)</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="checkbox" id="cbDots" class="w-5 h-5 text-gray-400">
                                    <i class="fas fa-ellipsis-h text-gray-400"></i>
                                    <span>...</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer mb-3">
                                <input type="checkbox" id="cbCustomKeywords" class="w-5 h-5 text-blue-600">
                                <i class="fas fa-search text-blue-600"></i>
                                <span class="font-semibold">Busca em "Outros" + Observa√ß√µes</span>
                            </label>
                            
                            <div id="keywordsSection" class="hidden">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Palavras-chave (uma por linha):
                                </label>
                                <textarea 
                                    id="customKeywords"
                                    rows="5"
                                    placeholder="Tr√°fego&#10;Tr√°fego Pago&#10;trafego face&#10;facebook ads"
                                    class="w-full border-2 border-gray-200 rounded-lg p-3 font-mono text-sm focus:outline-none focus:border-blue-500"
                                >Tr√°fego
Tr√°fego Pago
trafego
trafego pago</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Exclus√£o de Manuten√ß√µes -->
                    <div class="bg-white rounded-xl border-2 border-gray-200 p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <i class="fas fa-filter text-red-600"></i>
                            Filtros de Exclus√£o
                        </h3>
                        
                        <label class="flex items-center gap-3 p-3 border-2 border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="cbExcludeMaintenance" class="w-5 h-5 text-red-600">
                            <i class="fas fa-ban text-red-600"></i>
                            <div>
                                <span class="font-semibold">Excluir Manuten√ß√µes Ortod√¥nticas</span>
                                <p class="text-xs text-gray-600 mt-1">Remove da contagem: Manuten√ß√£o Aparelho M√≥vel, Manuten√ß√£o Aparelho Ortod√¥ntico (Autoligado/Safira), Manuten√ß√£o Ortod√¥ntica Mensal</p>
                            </div>
                        </label>
                    </div>

                    <button id="saveConfigBtn" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                        <i class="fas fa-save mr-2"></i>
                        Salvar Configura√ß√µes
                    </button>
                </div>

                <!-- Vincular Contas de An√∫ncios -->
                <div class="bg-white border-2 border-gray-200 rounded-xl p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-link text-green-600"></i>
                        Vincular Contas de An√∫ncios
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- Meta Ads -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fab fa-meta text-blue-600 mr-2"></i>
                                Meta Ads
                            </label>
                            <select id="metaAccountSelect" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                <option value="">Selecione uma conta Meta...</option>
                            </select>
                            <div id="metaAccountStatus" class="mt-2 text-sm"></div>
                        </div>

                        <!-- Google Ads -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fab fa-google text-red-600 mr-2"></i>
                                Google Ads
                            </label>
                            <select id="googleAccountSelect" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                                <option value="">Selecione uma conta Google...</option>
                            </select>
                            <div id="googleAccountStatus" class="mt-2 text-sm"></div>
                        </div>

                        <button id="saveLinkBtn" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold">
                            <i class="fas fa-save mr-2"></i>
                            Salvar Vincula√ß√µes
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { auth, db } from './config/firebase.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getUnit, updateUnit, updateBudgetData } from './services/unitsService.js';
        import { processSpreadsheet, validateSpreadsheet, mergeSpreadsheetData } from './services/spreadsheetProcessor.js';
        import { fbAuth } from './auth.js?v=3.0';
        import { googleAuth } from './authGoogle.js?v=3.0';

        let currentProjectId = null;
        let currentUnitId = null;
        let currentUnit = null;

        // Auth check
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '/login.html';
                return;
            }
            
            console.log('‚úÖ Usu√°rio autenticado:', user.email);
            
            // Mostrar links de admin
            if (user.email === 'thiagofelipefreire0810@gmail.com') {
                document.getElementById('adminLink').classList.remove('hidden');
                document.getElementById('analysisLink').classList.remove('hidden');
            }
            
            // Pegar IDs da URL
            const urlParams = new URLSearchParams(window.location.search);
            currentProjectId = urlParams.get('projectId');
            currentUnitId = urlParams.get('unitId');
            
            if (!currentProjectId || !currentUnitId) {
                alert('‚ùå Par√¢metros inv√°lidos');
                window.location.href = '/home.html';
                return;
            }
            
            // Atualizar links
            document.getElementById('telaInicialLink').href = `projeto.html?id=${currentProjectId}`;
            document.getElementById('unidadesLink').href = `unidades.html?projectId=${currentProjectId}`;
            document.getElementById('backLink').href = `unidades.html?projectId=${currentProjectId}`;
            
            // Carregar dados da unidade
            await loadUnit();
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
            }
        });

        // Carregar unidade
        async function loadUnit() {
            try {
                currentUnit = await getUnit(currentProjectId, currentUnitId);
                
                // ‚≠ê MIGRA√á√ÉO AUTOM√ÅTICA: Corrigir unidades antigas
                let needsUpdate = false;
                
                // Se customKeywords.enabled n√£o existe ou √© undefined, for√ßar para false
                if (currentUnit.customKeywords && currentUnit.customKeywords.enabled !== false && currentUnit.customKeywords.enabled !== true) {
                    console.log('üîÑ [MIGRA√á√ÉO] Corrigindo customKeywords.enabled de undefined para false');
                    currentUnit.customKeywords.enabled = false;
                    needsUpdate = true;
                }
                
                // Aplicar migra√ß√£o no Firestore
                if (needsUpdate) {
                    await updateUnit(currentProjectId, currentUnitId, {
                        customKeywords: currentUnit.customKeywords
                    });
                    console.log('‚úÖ [MIGRA√á√ÉO] Unidade atualizada no Firestore');
                }
                
                // Atualizar UI
                document.getElementById('unitName').textContent = currentUnit.name;
                
                // Carregar configura√ß√µes
                document.getElementById('cbFacebook').checked = currentUnit.trafficSources?.facebook === true;
                document.getElementById('cbInstagram').checked = currentUnit.trafficSources?.instagram === true;
                document.getElementById('cbGoogle').checked = currentUnit.trafficSources?.google === true;
                document.getElementById('cbRevista').checked = currentUnit.trafficSources?.revista === true;
                document.getElementById('cbEmpty').checked = currentUnit.trafficSources?.empty === true;
                document.getElementById('cbDots').checked = currentUnit.trafficSources?.dots === true;
                
                // ‚≠ê SEMPRE false por padr√£o (para unidades antigas sem o campo)
                const customKeywordsEnabled = currentUnit.customKeywords?.enabled === true;
                console.log('üîç [DEBUG] customKeywords.enabled:', currentUnit.customKeywords?.enabled, '‚Üí', customKeywordsEnabled);
                document.getElementById('cbCustomKeywords').checked = customKeywordsEnabled;
                document.getElementById('customKeywords').value = (currentUnit.customKeywords?.terms || []).join('\n');
                
                document.getElementById('cbExcludeMaintenance').checked = currentUnit.excludeMaintenance === true;
                
                toggleKeywordsSection();
                
                // Mostrar dados da planilha se existir
                if (currentUnit.budgetData) {
                    showBudgetData();
                }
                
                // Carregar contas vinculadas
                await loadLinkedAccounts();
                
            } catch (error) {
                console.error('Erro ao carregar unidade:', error);
                alert('Erro ao carregar dados da unidade');
            }
        }

        // Mostrar/ocultar se√ß√£o de palavras-chave
        document.getElementById('cbCustomKeywords').addEventListener('change', toggleKeywordsSection);
        
        function toggleKeywordsSection() {
            const section = document.getElementById('keywordsSection');
            if (document.getElementById('cbCustomKeywords').checked) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        }

        // Salvar configura√ß√µes
        document.getElementById('saveConfigBtn').addEventListener('click', async () => {
            try {
                const trafficSources = {
                    facebook: document.getElementById('cbFacebook').checked,
                    instagram: document.getElementById('cbInstagram').checked,
                    google: document.getElementById('cbGoogle').checked,
                    revista: document.getElementById('cbRevista').checked,
                    empty: document.getElementById('cbEmpty').checked,
                    dots: document.getElementById('cbDots').checked
                };
                
                const excludeMaintenance = document.getElementById('cbExcludeMaintenance').checked;
                
                const customKeywords = {
                    enabled: document.getElementById('cbCustomKeywords').checked,
                    terms: document.getElementById('customKeywords').value
                        .split('\n')
                        .map(t => t.trim())
                        .filter(t => t.length > 0)
                };
                
                await updateUnit(currentProjectId, currentUnitId, {
                    trafficSources,
                    customKeywords,
                    excludeMaintenance
                });
                
                alert('‚úÖ Configura√ß√µes salvas com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar configura√ß√µes:', error);
                alert('Erro ao salvar configura√ß√µes');
            }
        });

        // ========== VINCULAR CONTAS DE AN√öNCIOS ==========
        async function loadLinkedAccounts() {
            try {
                console.log('üöÄ [loadLinkedAccounts] Iniciando...');
                console.log('üì¶ [loadLinkedAccounts] currentUnit:', currentUnit);
                
                if (!currentUnit) {
                    console.warn('‚ö†Ô∏è [loadLinkedAccounts] currentUnit est√° vazio!');
                    return;
                }
                
                const linkedAccounts = currentUnit.linkedAccounts || {};
                console.log('üîó [loadLinkedAccounts] Contas j√° vinculadas:', linkedAccounts);
                
                // Carregar contas dispon√≠veis do Meta
                const metaSelect = document.getElementById('metaAccountSelect');
                const metaStatus = document.getElementById('metaAccountStatus');
                
                console.log('üìç [loadLinkedAccounts] Elements:', { metaSelect, metaStatus });
                
                try {
                    console.log('üîç [META] Verificando fbAuth:', fbAuth);
                    console.log('üîç [META] Verificando fbAuth.getAdAccounts:', fbAuth.getAdAccounts);
                    console.log('üîç [META] Chamando fbAuth.getAdAccounts()...');
                    
                    const adAccountsMap = fbAuth.getAdAccounts();
                    console.log('‚úÖ [META] adAccountsMap retornado:', adAccountsMap);
                    console.log('‚úÖ [META] Tipo:', typeof adAccountsMap);
                    
                    metaSelect.innerHTML = '<option value="">Nenhuma</option>';
                    
                    if (adAccountsMap && typeof adAccountsMap === 'object') {
                        const sortedAccounts = Object.entries(adAccountsMap)
                            .map(([id, name]) => ({ id, name }))
                            .sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
                        
                        console.log('‚úÖ [META] Contas ordenadas:', sortedAccounts);
                        
                        if (sortedAccounts.length > 0) {
                            sortedAccounts.forEach(acc => {
                                console.log('‚ûï [META] Adicionando conta:', acc);
                                const option = document.createElement('option');
                                option.value = acc.id;
                                option.textContent = acc.name;
                                option.dataset.name = acc.name;
                                metaSelect.appendChild(option);
                            });
                        } else {
                            console.warn('‚ö†Ô∏è [META] Nenhuma conta dispon√≠vel');
                            metaStatus.innerHTML = '<span class="text-yellow-600"><i class="fas fa-exclamation-triangle mr-1"></i>Nenhuma conta Meta encontrada</span>';
                        }
                    } else {
                        console.warn('‚ö†Ô∏è [META] adAccountsMap inv√°lido');
                        metaStatus.innerHTML = '<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>Conecte-se ao Meta primeiro</span>';
                    }
                    
                    if (linkedAccounts.meta) {
                        console.log('üîó [META] Selecionando conta vinculada:', linkedAccounts.meta);
                        metaSelect.value = linkedAccounts.meta.id;
                        metaStatus.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Vinculada: ${linkedAccounts.meta.name}</span>`;
                    }
                } catch (error) {
                    console.error('‚ùå [META] Erro completo:', error);
                    console.error('‚ùå [META] Stack:', error.stack);
                    metaStatus.innerHTML = '<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>Conecte-se ao Meta primeiro</span>';
                }
                
                // Carregar contas dispon√≠veis do Google
                const googleSelect = document.getElementById('googleAccountSelect');
                const googleStatus = document.getElementById('googleAccountStatus');
                
                try {
                    console.log('üîç [GOOGLE] Verificando googleAuth:', googleAuth);
                    console.log('üîç [GOOGLE] Verificando googleAuth.getStoredAccounts:', googleAuth.getStoredAccounts);
                    console.log('üîç [GOOGLE] Chamando googleAuth.getStoredAccounts()...');
                    
                    const googleAccounts = googleAuth.getStoredAccounts();
                    console.log('‚úÖ [GOOGLE] Contas retornadas:', googleAccounts);
                    console.log('‚úÖ [GOOGLE] Tipo:', typeof googleAccounts, 'Array?', Array.isArray(googleAccounts), 'Length:', googleAccounts?.length);
                    
                    googleSelect.innerHTML = '<option value="">Nenhuma</option>';
                    
                    if (Array.isArray(googleAccounts) && googleAccounts.length > 0) {
                        googleAccounts.forEach(acc => {
                            console.log('‚ûï [GOOGLE] Adicionando conta:', acc);
                            const option = document.createElement('option');
                            option.value = acc.customerId;
                            option.textContent = acc.name;
                            option.dataset.name = acc.name;
                            option.dataset.managedBy = acc.managedBy || '';
                            googleSelect.appendChild(option);
                        });
                    } else {
                        console.warn('‚ö†Ô∏è [GOOGLE] Nenhuma conta dispon√≠vel ou array vazio');
                        googleStatus.innerHTML = '<span class="text-yellow-600"><i class="fas fa-exclamation-triangle mr-1"></i>Nenhuma conta Google encontrada</span>';
                    }
                    
                    if (linkedAccounts.google) {
                        console.log('üîó [GOOGLE] Selecionando conta vinculada:', linkedAccounts.google);
                        googleSelect.value = linkedAccounts.google.id;
                        googleStatus.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Vinculada: ${linkedAccounts.google.name}</span>`;
                    }
                } catch (error) {
                    console.error('‚ùå [GOOGLE] Erro completo:', error);
                    console.error('‚ùå [GOOGLE] Stack:', error.stack);
                    googleStatus.innerHTML = '<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>Conecte-se ao Google primeiro</span>';
                }
            } catch (error) {
                console.error('‚ùå [loadLinkedAccounts] Erro geral:', error);
                console.error('‚ùå [loadLinkedAccounts] Stack:', error.stack);
            }
        }

        // Salvar vincula√ß√µes
        document.getElementById('saveLinkBtn').addEventListener('click', async () => {
            try {
                const metaSelect = document.getElementById('metaAccountSelect');
                const googleSelect = document.getElementById('googleAccountSelect');
                
                const linkedAccounts = {};
                
                if (metaSelect.value) {
                    const selectedOption = metaSelect.options[metaSelect.selectedIndex];
                    linkedAccounts.meta = {
                        id: metaSelect.value,
                        name: selectedOption.dataset.name || selectedOption.textContent
                    };
                }
                
                if (googleSelect.value) {
                    const selectedOption = googleSelect.options[googleSelect.selectedIndex];
                    linkedAccounts.google = {
                        id: googleSelect.value,
                        name: selectedOption.dataset.name || selectedOption.textContent
                    };
                }
                
                await updateUnit(currentProjectId, currentUnitId, { linkedAccounts });
                
                console.log('‚úÖ Contas vinculadas com sucesso:', linkedAccounts);
                
                // Atualizar status
                const metaStatus = document.getElementById('metaAccountStatus');
                const googleStatus = document.getElementById('googleAccountStatus');
                
                if (linkedAccounts.meta) {
                    metaStatus.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Vinculada: ${linkedAccounts.meta.name}</span>`;
                } else {
                    metaStatus.innerHTML = '';
                }
                
                if (linkedAccounts.google) {
                    googleStatus.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Vinculada: ${linkedAccounts.google.name}</span>`;
                } else {
                    googleStatus.innerHTML = '';
                }
                
                alert('‚úÖ Contas vinculadas com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao salvar vincula√ß√µes:', error);
                alert('‚ùå Erro ao salvar vincula√ß√µes');
            }
        });

        // Drag & Drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-100');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-100');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-100');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Processar arquivo
        async function handleFile(file) {
            try {
                // Validar
                validateSpreadsheet(file);
                
                console.log('üìä Processando arquivo:', file.name);
                
                // Mostrar progress
                document.getElementById('uploadProgress').classList.remove('hidden');
                updateProgress(0);
                
                // Atualizar unidade para pegar configura√ß√µes mais recentes
                currentUnit = await getUnit(currentProjectId, currentUnitId);
                
                updateProgress(30);
                
                // Processar planilha
                const newBudgetData = await processSpreadsheet(
                    file, 
                    currentUnit.trafficSources, 
                    currentUnit.customKeywords,
                    currentUnit.excludeMaintenance || false
                );
                
                console.log('üìä [handleFile] Dados processados:', {
                    arquivo: file.name,
                    registros: newBudgetData.rawData?.length || 0,
                    periodo: `${newBudgetData.periodStart} a ${newBudgetData.periodEnd}`,
                    orcamentos: newBudgetData.totalBudgets,
                    vendas: newBudgetData.totalSales,
                    faturamento: newBudgetData.totalRevenue
                });
                
                updateProgress(50);
                
                // üîÑ MESCLAR com dados existentes
                console.log('üîÑ [handleFile] Mesclando com dados existentes...');
                const mergedData = mergeSpreadsheetData(currentUnit.budgetData, newBudgetData);
                
                console.log('‚úÖ [handleFile] Mesclagem conclu√≠da!', {
                    totalFinal: mergedData.rawData?.length || 0,
                    periodo: `${mergedData.periodStart} a ${mergedData.periodEnd}`,
                    orcamentos: mergedData.totalBudgets,
                    vendas: mergedData.totalSales,
                    faturamento: mergedData.totalRevenue
                });
                
                updateProgress(70);
                
                // Salvar no Firestore
                console.log('üíæ [handleFile] Salvando no Firestore...');
                await updateBudgetData(currentProjectId, currentUnitId, mergedData);
                console.log('‚úÖ [handleFile] Dados salvos!');
                
                updateProgress(100);
                
                // Atualizar currentUnit
                currentUnit.budgetData = mergedData;
                
                // Mostrar dados
                showBudgetData();
                
                // Ocultar progress
                setTimeout(() => {
                    document.getElementById('uploadProgress').classList.add('hidden');
                    alert('‚úÖ Planilha importada com sucesso!');
                }, 500);
                
            } catch (error) {
                console.error('Erro ao processar planilha:', error);
                document.getElementById('uploadProgress').classList.add('hidden');
                alert(`‚ùå Erro: ${error.message}`);
            }
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressPercent').textContent = `${percent}%`;
        }

        // Mostrar dados da planilha
        function showBudgetData() {
            const data = currentUnit.budgetData;
            
            if (!data) return;
            
            // Cards
            document.getElementById('dataCards').classList.remove('hidden');
            document.getElementById('totalBudgets').textContent = data.totalBudgets;
            document.getElementById('totalSales').textContent = data.totalSales;
            document.getElementById('totalRevenue').textContent = `R$ ${data.totalRevenue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            // File info
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('fileName').textContent = data.fileName;
            document.getElementById('fileDate').textContent = `Per√≠odo: ${formatDate(data.periodStart)} a ${formatDate(data.periodEnd)}`;
            
            // Verificar per√≠odos sem dados
            checkMissingPeriods(data);
        }
        
        // Verificar per√≠odos sem dados
        function checkMissingPeriods(data) {
            if (!data || !data.periodStart || !data.periodEnd) {
                return;
            }
            
            console.log('üîç [checkMissingPeriods] Verificando per√≠odos sem dados...');
            
            // Usar allData (TODOS or√ßamentos) para detectar gaps
            const dataToCheck = data.allData || data.rawData || [];
            
            if (dataToCheck.length === 0) {
                console.log('‚ö†Ô∏è Sem dados para verificar');
                document.getElementById('missingPeriodsContainer').classList.add('hidden');
                document.getElementById('noDuplicatesContainer').classList.add('hidden');
                return;
            }
            
            // Criar set com todas as datas que temos dados (QUALQUER or√ßamento)
            const existingDates = new Set(dataToCheck.map(item => item.date));
            console.log('üìÖ Total de datas com dados (geral):', existingDates.size);
            console.log('üìä Or√ßamentos de tr√°fego:', data.rawData?.length || 0);
            
            // Gerar lista de TODAS as datas esperadas no per√≠odo
            const startDate = new Date(data.periodStart + 'T00:00:00');
            const endDate = new Date(data.periodEnd + 'T00:00:00');
            
            const missingDates = [];
            const currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                
                if (!existingDates.has(dateStr)) {
                    missingDates.push(dateStr);
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            console.log('‚ùå Datas faltando:', missingDates.length);
            
            // Se n√£o tem datas faltando
            if (missingDates.length === 0) {
                document.getElementById('missingPeriodsContainer').classList.add('hidden');
                document.getElementById('noDuplicatesContainer').classList.remove('hidden');
                return;
            }
            
            // Agrupar datas consecutivas em per√≠odos
            const periods = [];
            let periodStart = missingDates[0];
            let periodEnd = missingDates[0];
            
            for (let i = 1; i < missingDates.length; i++) {
                const prevDate = new Date(missingDates[i - 1]);
                const currDate = new Date(missingDates[i]);
                
                const dayDiff = (currDate - prevDate) / (1000 * 60 * 60 * 24);
                
                if (dayDiff === 1) {
                    // Consecutivo
                    periodEnd = missingDates[i];
                } else {
                    // Quebra - salvar per√≠odo anterior
                    periods.push({ start: periodStart, end: periodEnd });
                    periodStart = missingDates[i];
                    periodEnd = missingDates[i];
                }
            }
            
            // Adicionar √∫ltimo per√≠odo
            periods.push({ start: periodStart, end: periodEnd });
            
            // üî• FILTRAR: Apenas per√≠odos com 5+ dias consecutivos
            const significantPeriods = periods.filter(period => {
                const start = new Date(period.start + 'T00:00:00');
                const end = new Date(period.end + 'T00:00:00');
                const days = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
                return days >= 5;
            });
            
            console.log('üìä Per√≠odos SIGNIFICATIVOS (5+ dias):', significantPeriods);
            
            // Se n√£o tem per√≠odos significativos
            if (significantPeriods.length === 0) {
                document.getElementById('missingPeriodsContainer').classList.add('hidden');
                document.getElementById('noDuplicatesContainer').classList.remove('hidden');
                return;
            }
            
            // Renderizar lista de per√≠odos significativos
            const listEl = document.getElementById('missingPeriodsList');
            listEl.innerHTML = '';
            
            significantPeriods.forEach(period => {
                const li = document.createElement('li');
                
                const start = new Date(period.start + 'T00:00:00');
                const end = new Date(period.end + 'T00:00:00');
                const days = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                if (period.start === period.end) {
                    li.textContent = `‚Ä¢ ${formatDate(period.start)} (1 dia)`;
                } else {
                    li.textContent = `‚Ä¢ ${formatDate(period.start)} a ${formatDate(period.end)} (${days} dias)`;
                }
                
                listEl.appendChild(li);
            });
            
            document.getElementById('missingPeriodsContainer').classList.remove('hidden');
            document.getElementById('noDuplicatesContainer').classList.add('hidden');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('pt-BR');
        }

        // ========== BOT√ÉO VOLTAR ==========
        document.getElementById('backLink').addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = `unidades.html?projectId=${currentProjectId}`;
        });

        // ========== LOGOUT ==========
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = '/login.html';
            } catch (error) {
                console.error('‚ùå Erro ao fazer logout:', error);
            }
        });
    </script>
</body>
</html>

