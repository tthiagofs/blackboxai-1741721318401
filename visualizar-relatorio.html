<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizar Relat√≥rio - Insightflow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-white min-h-screen font-sans m-0 p-0">
    
    <!-- Sidebar -->
    <aside class="fixed left-0 top-0 h-full w-64 bg-white border-r border-gray-200 flex flex-col z-50">
        <div class="p-6 border-b border-gray-200">
            <h1 class="text-2xl font-bold text-gray-900">Insightflow</h1>
            <p class="text-sm text-gray-600 mt-1">Visualizar Relat√≥rio</p>
        </div>
        
        <nav class="flex-1 p-4">
            <a href="javascript:history.back()" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-all mb-2">
                <i class="fas fa-arrow-left mr-3 text-gray-600"></i>
                <span>Voltar</span>
            </a>
            <a href="/dashboard.html" class="flex items-center px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg transition-all">
                <i class="fas fa-home mr-3 text-gray-600"></i>
                <span>Dashboard</span>
            </a>
        </nav>
        
        <div class="p-4 border-t border-gray-200">
            <button id="logoutBtn" class="w-full flex items-center justify-center px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition-all">
                <i class="fas fa-sign-out-alt mr-2"></i>
                <span>Sair</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="ml-64 bg-gray-50 min-h-screen">
        <div class="p-8">
            <!-- Loading -->
            <div id="loadingSection" class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                <p class="text-gray-600 text-lg mb-2">Carregando relat√≥rio...</p>
                <p class="text-gray-500 text-sm">Buscando dados atualizados da API</p>
            </div>

            <!-- Relat√≥rio Container (ser√° preenchido pelo JS) -->
            <div id="reportContainer" class="hidden"></div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://connect.facebook.net/en_US/sdk.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script type="module">
        import { auth } from './config/firebase.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { reportsService } from './services/reportsService.js?v=1.0';
        import { connectionService } from './services/connectionService.js?v=1.0';
        import { FacebookInsightsService } from './services/facebookInsights.js?v=3.0';
        import { exportToPDF } from './exportPDF.js';

        console.log('üî• Firebase inicializado com sucesso!');

        let reportData = null;
        let generatedMetrics = null;

        // Verificar autentica√ß√£o
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                console.log('‚ö†Ô∏è Usu√°rio n√£o autenticado, redirecionando...');
                window.location.href = '/login.html';
                return;
            }

            console.log('‚úÖ Usu√°rio autenticado:', user.email);
            
            // Carregar conex√µes salvas
            await connectionService.initialize();
            
            // Inicializar Facebook SDK (sempre chamar init, mesmo se j√° carregado)
            await initializeFacebookSDK();
            
            // Carregar e regenerar relat√≥rio
            await loadAndRegenerateReport();
        });

        // Inicializar Facebook SDK
        function initializeFacebookSDK() {
            return new Promise((resolve) => {
                // Se o FB j√° existe, apenas inicializar
                if (typeof FB !== 'undefined') {
                    console.log('üì± Facebook SDK j√° carregado, inicializando...');
                    FB.init({
                        appId: '8664931536960419',
                        cookie: true,
                        xfbml: true,
                        version: 'v18.0'
                    });
                    console.log('‚úÖ Facebook SDK inicializado');
                    resolve();
                } else {
                    // Caso n√£o exista, aguardar o carregamento
                    window.fbAsyncInit = function() {
                        FB.init({
                            appId: '8664931536960419',
                            cookie: true,
                            xfbml: true,
                            version: 'v18.0'
                        });
                        console.log('‚úÖ Facebook SDK inicializado (async)');
                        resolve();
                    };
                }
            });
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = '/login.html';
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
            }
        });

        // Carregar e regenerar relat√≥rio
        async function loadAndRegenerateReport() {
            const urlParams = new URLSearchParams(window.location.search);
            const reportId = urlParams.get('report');
            const projectId = localStorage.getItem('currentProject');

            console.log('üîç URL Params - reportId:', reportId, 'projectId:', projectId);

            if (!reportId || !projectId) {
                alert('Erro: Relat√≥rio n√£o encontrado');
                window.location.href = '/dashboard.html';
                return;
            }

            try {
                console.log('üì• Carregando relat√≥rio:', reportId);
                reportData = await reportsService.getReport(projectId, reportId);
                
                console.log('‚úÖ Relat√≥rio carregado:', reportData);
                console.log('üîÑ Regenerando dados da API...');
                
                // Regenerar m√©tricas com dados atualizados da API
                await regenerateMetrics();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar relat√≥rio:', error);
                
                // Verificar se √© erro de token expirado
                if (error.message === 'TOKEN_EXPIRED' || error.message.includes('Session has expired')) {
                    alert('‚ö†Ô∏è Sua sess√£o do Facebook expirou!\n\nPor favor, v√° at√© a tela de CONEX√ïES e fa√ßa login novamente.');
                    setTimeout(() => {
                        if (confirm('Deseja ir para a tela de CONEX√ïES agora?')) {
                            window.location.href = '/conexoes.html?tokenExpired=true';
                        }
                    }, 1000);
                } else {
                    alert('Erro ao carregar relat√≥rio');
                    window.location.href = '/dashboard.html';
                }
            }
        }

        // Regenerar m√©tricas da API
        async function regenerateMetrics() {
            console.log('üîÑ [regenerateMetrics] Iniciando regenera√ß√£o...');
            const loadingSection = document.getElementById('loadingSection');
            const loadingText = loadingSection.querySelector('p:last-child');
            
            try {
                console.log('üìä [regenerateMetrics] Plataforma:', reportData.platform);
                let metrics = null;
                let blackMetrics = null;
                let bestAds = [];
                let comparisonMetrics = null;

                // ========== META ADS ==========
                if (reportData.platform === 'meta' || reportData.platform === 'both') {
                    console.log('üì± [regenerateMetrics] Processando Meta Ads...');
                    loadingText.textContent = 'Buscando dados do Meta Ads...';
                    
                    // IMPORTANTE: Recarregar conex√µes do Firestore para pegar token atualizado
                    console.log('üîÑ Recarregando conex√µes do Firestore...');
                    await connectionService.loadConnections();
                    
                    // Obter token do Meta (agora atualizado)
                    const connections = connectionService.getConnectionStatus();
                    console.log('üîå [regenerateMetrics] Status conex√µes (recarregado):', connections);
                    
                    if (!connections.meta.connected) {
                        console.error('‚ùå Meta Ads n√£o conectado!');
                        throw new Error('Meta Ads n√£o conectado. V√° para CONEX√ïES e fa√ßa login.');
                    }

                    console.log('‚úÖ Token Meta obtido, criando FacebookInsightsService...');
                    console.log('üîë Token (primeiros 20 chars):', connections.meta.token?.substring(0, 20) + '...');
                    const metaAccount = reportData.metaAccount;
                    const insightsService = new FacebookInsightsService(connections.meta.token);

                    // Buscar m√©tricas
                    metrics = await insightsService.getAccountInsights(
                        metaAccount.id,
                        reportData.analysisStart,
                        reportData.analysisEnd
                    );

                    // Se tem Black, buscar tamb√©m
                    if (reportData.manualData.hasBlack) {
                        blackMetrics = await insightsService.getAccountInsights(
                            metaAccount.id,
                            reportData.analysisStart,
                            reportData.analysisEnd,
                            true // isBlack
                        );
                    }

                    // Buscar melhores an√∫ncios
                    loadingText.textContent = 'Buscando melhores an√∫ncios...';
                    bestAds = await insightsService.getBestPerformingAds(
                        metaAccount.id,
                        reportData.analysisStart,
                        reportData.analysisEnd
                    );

                    // Se tem per√≠odo de compara√ß√£o
                    if (reportData.comparisonStart && reportData.comparisonEnd) {
                        loadingText.textContent = 'Buscando dados de compara√ß√£o...';
                        const comparisonData = await insightsService.getComparisonData(
                            metaAccount.id,
                            reportData.comparisonStart,
                            reportData.comparisonEnd
                        );
                        comparisonMetrics = comparisonData.metrics;
                    }
                }

                // ========== GOOGLE ADS ==========
                if (reportData.platform === 'google' || reportData.platform === 'both') {
                    loadingText.textContent = 'Buscando dados do Google Ads...';
                    // TODO: Implementar Google Ads quando necess√°rio
                    console.log('‚ö†Ô∏è Google Ads ainda n√£o implementado na visualiza√ß√£o');
                }

                // Armazenar m√©tricas regeneradas
                generatedMetrics = {
                    metrics,
                    blackMetrics,
                    bestAds,
                    comparisonMetrics
                };

                // Renderizar relat√≥rio completo
                console.log('üìä Dados regenerados, renderizando...');
                console.log('- Metrics:', metrics);
                console.log('- Best Ads:', bestAds?.length);
                renderCompleteReport();
                
            } catch (error) {
                console.error('‚ùå Erro ao regenerar m√©tricas:', error);
                console.error('Detalhes do erro:', error.message, error.stack);
                throw error;
            }
        }

        // Renderizar relat√≥rio completo
        function renderCompleteReport() {
            console.log('üé® [renderCompleteReport] Iniciando renderiza√ß√£o...');
            const loadingSection = document.getElementById('loadingSection');
            const reportContainer = document.getElementById('reportContainer');

            console.log('üé® [renderCompleteReport] Elementos DOM obtidos');
            
            // Ocultar loading
            loadingSection.classList.add('hidden');
            reportContainer.classList.remove('hidden');
            
            console.log('üé® [renderCompleteReport] Loading ocultado, container exibido');

            const { metrics, blackMetrics, bestAds, comparisonMetrics } = generatedMetrics;
            const { manualData } = reportData;

            // Calcular CPM (custo por mensagem)
            const cpm = metrics.conversations > 0 ? metrics.spend / metrics.conversations : 0;
            const blackCpm = blackMetrics && blackMetrics.conversations > 0 ? blackMetrics.spend / blackMetrics.conversations : 0;

            // Header com bot√£o exportar
            reportContainer.innerHTML = `
                <!-- Header -->
                <div class="mb-6 flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">${reportData.reportName}</h2>
                        <p class="text-gray-600 mt-1">Per√≠odo: ${reportData.dateRange}</p>
                    </div>
                    
                    <button id="exportPdfBtn" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3 px-6 rounded-xl transition duration-300 transform hover:scale-[1.02] shadow-lg flex items-center">
                        <i class="fas fa-file-pdf mr-2 text-xl"></i>
                        <span class="text-lg">Exportar PDF</span>
                    </button>
                </div>

                <!-- Conte√∫do do Relat√≥rio -->
                <div id="report-content" class="space-y-6">
                    ${renderMetricsSection(metrics, blackMetrics, cpm, blackCpm)}
                    ${renderBusinessResults(manualData)}
                    ${renderBestAds(bestAds)}
                    ${comparisonMetrics ? renderComparison(metrics, comparisonMetrics) : ''}
                </div>
            `;

            // Adicionar evento ao bot√£o exportar
            document.getElementById('exportPdfBtn').addEventListener('click', () => {
                exportToPDF();
            });
        }

        // Renderizar se√ß√£o de m√©tricas
        function renderMetricsSection(metrics, blackMetrics, cpm, blackCpm) {
            const hasBlack = reportData.manualData.hasBlack && blackMetrics;
            
            return `
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl shadow-lg p-8 text-white">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-chart-bar mr-3"></i>
                        CAMPANHAS${hasBlack ? ' WHITE' : ''}
                    </h3>
                    
                    <div class="grid grid-cols-4 gap-4">
                        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                            <p class="text-sm opacity-90 mb-1">INVESTIMENTO</p>
                            <p class="text-2xl font-bold">R$ ${metrics.spend.toFixed(2)}</p>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                            <p class="text-sm opacity-90 mb-1">ALCANCE</p>
                            <p class="text-2xl font-bold">${metrics.reach.toLocaleString('pt-BR')}</p>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                            <p class="text-sm opacity-90 mb-1">CONVERSAS INICIADAS</p>
                            <p class="text-2xl font-bold">${metrics.conversations}</p>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                            <p class="text-sm opacity-90 mb-1">CUSTO POR CONVERSA</p>
                            <p class="text-2xl font-bold">R$ ${cpm.toFixed(2)}</p>
                        </div>
                    </div>
                </div>

                ${hasBlack ? `
                <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl shadow-lg p-8 text-white">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-chart-bar mr-3"></i>
                        CAMPANHAS BLACK
                    </h3>
                    
                    <div class="grid grid-cols-4 gap-4">
                        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                            <p class="text-sm opacity-90 mb-1">INVESTIMENTO</p>
                            <p class="text-2xl font-bold">R$ ${blackMetrics.spend.toFixed(2)}</p>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                            <p class="text-sm opacity-90 mb-1">ALCANCE</p>
                            <p class="text-2xl font-bold">${blackMetrics.reach.toLocaleString('pt-BR')}</p>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                            <p class="text-sm opacity-90 mb-1">CONVERSAS INICIADAS</p>
                            <p class="text-2xl font-bold">${blackMetrics.conversations}</p>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                            <p class="text-sm opacity-90 mb-1">CUSTO POR CONVERSA</p>
                            <p class="text-2xl font-bold">R$ ${blackCpm.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
        }

        // Renderizar resultados do neg√≥cio
        function renderBusinessResults(manualData) {
            return `
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                        <i class="fas fa-trophy text-yellow-500 mr-3"></i>
                        RESULTADOS DO NEG√ìCIO
                    </h3>
                    
                    <div class="grid grid-cols-3 gap-6">
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2">Or√ßamentos Conclu√≠dos</p>
                            <p class="text-4xl font-bold text-green-600">${manualData.budgets}</p>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2">N√∫mero de Vendas</p>
                            <p class="text-4xl font-bold text-blue-600">${manualData.sales}</p>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <p class="text-sm text-gray-600 mb-2">Faturamento</p>
                            <p class="text-4xl font-bold text-purple-600">R$ ${manualData.revenue.toLocaleString('pt-BR')}</p>
                        </div>
                    </div>

                    ${manualData.analysis ? `
                    <div class="mt-6 bg-blue-50 border-l-4 border-blue-600 p-4">
                        <p class="text-sm font-semibold text-gray-700 mb-2">AN√ÅLISE DE DESEMPENHO E PONTOS DE MELHORIA</p>
                        <p class="text-gray-800">${manualData.analysis}</p>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Renderizar melhores an√∫ncios
        function renderBestAds(bestAds) {
            if (!bestAds || bestAds.length === 0) {
                return '';
            }

            const adsHTML = bestAds.map((ad, index) => `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-start mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center text-white font-bold text-xl mr-4">
                            ${index + 1}¬∫
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-900 mb-1">${ad.name || 'Sem nome'}</h4>
                            <p class="text-sm text-gray-600">ID: ${ad.id}</p>
                        </div>
                    </div>

                    ${ad.thumbnail ? `
                    <div class="mb-4 rounded-lg overflow-hidden">
                        <img src="${ad.thumbnail}" alt="Preview" class="w-full h-auto">
                    </div>
                    ` : ''}

                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-blue-50 p-3 rounded">
                            <p class="text-xs text-gray-600 mb-1">Investimento</p>
                            <p class="text-lg font-bold text-blue-600">R$ ${(ad.spend || 0).toFixed(2)}</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded">
                            <p class="text-xs text-gray-600 mb-1">Conversas</p>
                            <p class="text-lg font-bold text-green-600">${ad.conversations || 0}</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded">
                            <p class="text-xs text-gray-600 mb-1">Alcance</p>
                            <p class="text-lg font-bold text-purple-600">${(ad.reach || 0).toLocaleString('pt-BR')}</p>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded">
                            <p class="text-xs text-gray-600 mb-1">CPM</p>
                            <p class="text-lg font-bold text-yellow-600">R$ ${ad.conversations > 0 ? (ad.spend / ad.conversations).toFixed(2) : '0.00'}</p>
                        </div>
                    </div>
                </div>
            `).join('');

            return `
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl shadow-lg p-8 text-white">
                    <h3 class="text-2xl font-bold mb-6 flex items-center">
                        <i class="fas fa-star mr-3"></i>
                        MELHORES AN√öNCIOS
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-6">
                        ${adsHTML}
                    </div>
                </div>
            `;
        }

        // Renderizar compara√ß√£o
        function renderComparison(currentMetrics, comparisonMetrics) {
            const spendDiff = currentMetrics.spend - comparisonMetrics.spend;
            const reachDiff = currentMetrics.reach - comparisonMetrics.reach;
            const convDiff = currentMetrics.conversations - comparisonMetrics.conversations;
            
            const currentCpm = currentMetrics.conversations > 0 ? currentMetrics.spend / currentMetrics.conversations : 0;
            const compCpm = comparisonMetrics.conversations > 0 ? comparisonMetrics.spend / comparisonMetrics.conversations : 0;
            const cpmDiff = currentCpm - compCpm;

            const formatDiff = (value, isNegativeGood = false) => {
                const isPositive = value >= 0;
                const colorClass = (isNegativeGood ? !isPositive : isPositive) ? 'text-green-600' : 'text-red-600';
                const icon = isPositive ? '‚Üë' : '‚Üì';
                return `<span class="${colorClass} font-bold">${icon} ${Math.abs(value).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>`;
            };

            return `
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                        <i class="fas fa-exchange-alt text-indigo-600 mr-3"></i>
                        COMPARA√á√ÉO DE PER√çODOS
                    </h3>
                    
                    <div class="grid grid-cols-4 gap-4">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <p class="text-sm text-gray-600 mb-2">Investimento</p>
                            <p class="text-xl font-bold text-gray-900">R$ ${currentMetrics.spend.toFixed(2)}</p>
                            <p class="text-sm mt-1">${formatDiff(spendDiff)}</p>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-4">
                            <p class="text-sm text-gray-600 mb-2">Alcance</p>
                            <p class="text-xl font-bold text-gray-900">${currentMetrics.reach.toLocaleString('pt-BR')}</p>
                            <p class="text-sm mt-1">${formatDiff(reachDiff)}</p>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-4">
                            <p class="text-sm text-gray-600 mb-2">Conversas</p>
                            <p class="text-xl font-bold text-gray-900">${currentMetrics.conversations}</p>
                            <p class="text-sm mt-1">${formatDiff(convDiff)}</p>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-4">
                            <p class="text-sm text-gray-600 mb-2">Custo/Conversa</p>
                            <p class="text-xl font-bold text-gray-900">R$ ${currentCpm.toFixed(2)}</p>
                            <p class="text-sm mt-1">${formatDiff(cpmDiff, true)}</p>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
