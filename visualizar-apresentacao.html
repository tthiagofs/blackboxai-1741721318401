<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizar Apresentação - Insightflow</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos para edição inline */
        .editable {
            position: relative;
            transition: all 0.2s;
        }
        
        .editable:hover {
            background-color: rgba(147, 51, 234, 0.1);
            outline: 2px dashed rgba(147, 51, 234, 0.3);
            outline-offset: 2px;
            cursor: text;
        }
        
        .editable[contenteditable="true"] {
            background-color: rgba(147, 51, 234, 0.15);
            outline: 2px solid rgba(147, 51, 234, 0.5);
            outline-offset: 2px;
        }
        
        .editable[contenteditable="true"]:focus {
            outline: 2px solid rgba(147, 51, 234, 0.8);
            background-color: rgba(147, 51, 234, 0.2);
        }
        
        /* Botão flutuante de salvar */
        .save-button-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Indicador de edição */
        .edit-indicator {
            position: absolute;
            top: -25px;
            left: 0;
            font-size: 11px;
            color: #9333EA;
            background: white;
            padding: 2px 6px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            border: 1px solid rgba(147, 51, 234, 0.2);
        }
        
        .editable:hover .edit-indicator {
            opacity: 1;
        }
        
        /* Preview container */
        .presentation-container {
            background: #f0f0f0;
            padding: 40px 20px;
            min-height: 100vh;
        }
        
        .presentation-container .page {
            margin: 20px auto;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button onclick="window.history.back()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="fas fa-arrow-left text-gray-700"></i>
                        </button>
                        <div>
                            <h1 id="presentationName" class="text-xl font-bold text-gray-900">Carregando...</h1>
                            <p class="text-sm text-gray-600">Clique nos elementos para editar</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="toggleEditBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all flex items-center gap-2">
                            <i class="fas fa-edit"></i>
                            Modo Edição
                        </button>
                        <button id="exportPDFBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2">
                            <i class="fas fa-download"></i>
                            Exportar PDF
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Container da Apresentação -->
        <div id="presentationContainer" class="presentation-container">
            <div class="text-center py-20">
                <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-purple-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Carregando apresentação...</p>
            </div>
        </div>

        <!-- Botão Flutuante Salvar -->
        <div id="saveButtonContainer" class="save-button-container hidden">
            <button id="saveChangesBtn" class="bg-green-600 text-white px-6 py-3 rounded-xl shadow-lg hover:bg-green-700 transition-all flex items-center gap-2 font-semibold">
                <i class="fas fa-save"></i>
                Salvar Alterações
            </button>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './config/firebase.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { presentationsService } from './services/presentationsService.js?v=1.0';

        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('projectId');
        const presentationId = urlParams.get('id');

        let isEditMode = true;
        let hasUnsavedChanges = false;
        let originalHTML = '';
        let customData = {};

        // Elementos DOM
        const presentationContainer = document.getElementById('presentationContainer');
        const saveButtonContainer = document.getElementById('saveButtonContainer');
        const saveChangesBtn = document.getElementById('saveChangesBtn');
        const toggleEditBtn = document.getElementById('toggleEditBtn');
        const exportPDFBtn = document.getElementById('exportPDFBtn');
        const presentationName = document.getElementById('presentationName');

        // Carregar apresentação
        async function loadPresentation() {
            try {
                const presentation = await presentationsService.getPresentation(projectId, presentationId);
                
                presentationName.textContent = presentation.presentationName || 'Apresentação';
                
                // Carregar customData se existir
                customData = presentation.customData || {};
                
                // Obter HTML original ou usar o salvo
                originalHTML = presentation.presentationHTML || presentation.html || '';
                
                // Renderizar apresentação
                renderPresentation(originalHTML);
                
                // Aplicar customizações
                applyCustomizations();
                
                // Ativar modo de edição
                enableEditMode();
                
            } catch (error) {
                console.error('❌ Erro ao carregar apresentação:', error);
                presentationContainer.innerHTML = `
                    <div class="text-center py-20">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Erro ao carregar apresentação</h2>
                        <p class="text-gray-600">${error.message}</p>
                    </div>
                `;
            }
        }

        // Renderizar apresentação
        function renderPresentation(html) {
            presentationContainer.innerHTML = html;
            
            // Aguardar carregamento de fontes e imagens
            document.fonts.ready.then(() => {
                waitForImages().then(() => {
                    console.log('✅ Apresentação renderizada');
                });
            });
        }

        // Aguardar carregamento de imagens
        function waitForImages() {
            const images = Array.from(document.querySelectorAll('img'));
            return Promise.all(
                images.map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise(resolve => {
                        img.onload = resolve;
                        img.onerror = resolve;
                    });
                })
            );
        }

        // Aplicar customizações salvas
        function applyCustomizations() {
            if (!customData || Object.keys(customData).length === 0) return;
            
            // Aguardar um pouco para garantir que todos os elementos foram renderizados
            setTimeout(() => {
                Object.keys(customData).forEach(editId => {
                    const element = document.querySelector(`[data-edit-id="${editId}"]`);
                    if (element) {
                        // Preservar HTML interno se necessário
                        const customValue = customData[editId];
                        element.textContent = customValue;
                        element.setAttribute('data-original-value', customValue);
                        console.log(`✅ Aplicada customização para: ${editId} = ${customValue}`);
                    } else {
                        console.warn(`⚠️ Elemento não encontrado: ${editId}`);
                    }
                });
            }, 500);
        }

        // Ativar modo de edição
        function enableEditMode() {
            // Encontrar todos os elementos editáveis
            const editables = [
                // Capa
                '.capa-title',
                '.capa-unidade',
                '.capa-periodo',
                
                // Resultados
                '.card-value',
                '.card-label',
                '.resultados-title',
                '.resultados-subtitle',
                
                // Ranking
                '.ranking-title',
                '.ranking-metrics-leads',
                '.ranking-metrics-cost',
                
                // Próximos Passos
                '.proximos-title',
                '.proximos-subtitle',
                '.proximos-list li',
                
                // Obrigado
                '.obrigado-text'
            ];

            editables.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach((element, index) => {
                    // Criar ID único
                    const editId = `${selector.replace(/[.#\s]/g, '_')}_${index}`;
                    element.setAttribute('data-edit-id', editId);
                    element.classList.add('editable');
                    
                    // Adicionar indicador
                    const indicator = document.createElement('span');
                    indicator.className = 'edit-indicator';
                    indicator.textContent = 'Clique para editar';
                    element.style.position = 'relative';
                    element.appendChild(indicator);
                    
                    // Event listeners
                    element.addEventListener('click', () => {
                        if (isEditMode && !element.hasAttribute('contenteditable')) {
                            startEditing(element, editId);
                        }
                    });
                    
                    element.addEventListener('blur', () => {
                        stopEditing(element, editId);
                    });
                });
            });
        }

        // Iniciar edição
        function startEditing(element, editId) {
            element.setAttribute('contenteditable', 'true');
            element.focus();
            
            // Selecionar texto
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }

        // Parar edição
        function stopEditing(element, editId) {
            element.removeAttribute('contenteditable');
            
            // Salvar alteração
            const newValue = element.textContent.trim();
            
            // Obter valor original (da primeira renderização ou do customData)
            if (!element.hasAttribute('data-original-value')) {
                // Primeira vez editando - salvar valor original
                const originalText = element.textContent.trim();
                element.setAttribute('data-original-value', originalText);
            }
            
            const originalValue = element.getAttribute('data-original-value') || '';
            
            if (newValue !== originalValue && newValue !== '') {
                customData[editId] = newValue;
                markAsChanged();
                console.log(`💾 Alteração salva: ${editId} = ${newValue}`);
            }
        }

        // Marcar como alterado
        function markAsChanged() {
            if (!hasUnsavedChanges) {
                hasUnsavedChanges = true;
                saveButtonContainer.classList.remove('hidden');
            }
        }

        // Salvar alterações
        async function saveChanges() {
            if (!hasUnsavedChanges) {
                alert('Nenhuma alteração para salvar');
                return;
            }

            saveChangesBtn.disabled = true;
            saveChangesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

            try {
                await presentationsService.updatePresentation(projectId, presentationId, {
                    customData: customData,
                    updatedAt: new Date().toISOString()
                });

                hasUnsavedChanges = false;
                saveButtonContainer.classList.add('hidden');
                saveChangesBtn.disabled = false;
                saveChangesBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Alterações';

                // Mostrar feedback
                showNotification('Alterações salvas com sucesso!', 'success');

            } catch (error) {
                console.error('❌ Erro ao salvar:', error);
                saveChangesBtn.disabled = false;
                saveChangesBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Alterações';
                showNotification('Erro ao salvar alterações', 'error');
            }
        }

        // Mostrar notificação
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Toggle modo de edição
        toggleEditBtn.addEventListener('click', () => {
            isEditMode = !isEditMode;
            
            const editables = document.querySelectorAll('.editable');
            editables.forEach(el => {
                if (isEditMode) {
                    el.style.cursor = 'text';
                } else {
                    el.style.cursor = 'default';
                    el.removeAttribute('contenteditable');
                }
            });

            toggleEditBtn.innerHTML = isEditMode 
                ? '<i class="fas fa-edit"></i> Modo Edição'
                : '<i class="fas fa-eye"></i> Modo Visualização';
        });

        // Salvar alterações
        saveChangesBtn.addEventListener('click', saveChanges);

        // Exportar PDF
        exportPDFBtn.addEventListener('click', () => {
            // Obter HTML atualizado
            const currentHTML = presentationContainer.innerHTML;
            
            // Salvar em sessionStorage para o apresentacao-print.html usar
            sessionStorage.setItem('presentationPrintPayload', JSON.stringify({
                html: currentHTML
            }));
            
            // Abrir página de impressão
            window.open(`apresentacao-print.html?mode=session&auto=1`, '_blank');
        });

        // Carregar quando autenticado
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await loadPresentation();
            } else {
                window.location.href = '/login.html';
            }
        });
    </script>
    <script type="module">
        import { initSidebar } from './components/sidebar.js';
        initSidebar();
    </script>
</body>
</html>

