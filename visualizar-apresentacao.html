<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizar Apresenta√ß√£o - Insightflow</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos para edi√ß√£o inline */
        .editable {
            position: relative;
            transition: all 0.2s;
        }
        
        .editable:hover {
            background-color: rgba(147, 51, 234, 0.1);
            outline: 2px dashed rgba(147, 51, 234, 0.3);
            outline-offset: 2px;
            cursor: text;
        }
        
        .editable[contenteditable="true"] {
            background-color: rgba(147, 51, 234, 0.15);
            outline: 2px solid rgba(147, 51, 234, 0.5);
            outline-offset: 2px;
        }
        
        .editable[contenteditable="true"]:focus {
            outline: 2px solid rgba(147, 51, 234, 0.8);
            background-color: rgba(147, 51, 234, 0.2);
        }
        
        /* Bot√£o flutuante de salvar */
        .save-button-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Preview container */
        .presentation-container {
            background: #f0f0f0;
            padding: 40px 20px;
            min-height: 100vh;
        }
        
        .presentation-container .page {
            margin: 20px auto;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button onclick="window.history.back()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <i class="fas fa-arrow-left text-gray-700"></i>
                        </button>
                        <div>
                            <h1 id="presentationName" class="text-xl font-bold text-gray-900">Carregando...</h1>
                            <p class="text-sm text-gray-600">Ative o modo edi√ß√£o para personalizar os dados</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="toggleEditBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all flex items-center gap-2">
                            <i class="fas fa-edit"></i>
                            Modo Edi√ß√£o
                        </button>
                        <button id="saveBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all flex items-center gap-2 hidden">
                            <i class="fas fa-save"></i>
                            Salvar
                        </button>
                        <button id="exportPDFBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2">
                            <i class="fas fa-download"></i>
                            Exportar PDF
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Container da Apresenta√ß√£o -->
        <div id="presentationContainer" class="presentation-container">
            <div class="text-center py-20">
                <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-purple-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Carregando apresenta√ß√£o...</p>
            </div>
        </div>

        <!-- Bot√£o Flutuante Salvar -->
        <div id="saveButtonContainer" class="save-button-container hidden">
            <button id="saveChangesBtn" class="bg-green-600 text-white px-6 py-3 rounded-xl shadow-lg hover:bg-green-700 transition-all flex items-center gap-2 font-semibold">
                <i class="fas fa-save"></i>
                Salvar Altera√ß√µes
            </button>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './config/firebase.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { presentationsService } from './services/presentationsService.js?v=1.0';

        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('projectId');
        const presentationId = urlParams.get('id');

        let isEditMode = false; // Iniciar em modo visualiza√ß√£o
        let hasUnsavedChanges = false;
        let originalHTML = '';
        let customData = {};

        // Elementos DOM
        const presentationContainer = document.getElementById('presentationContainer');
        const saveButtonContainer = document.getElementById('saveButtonContainer');
        const saveChangesBtn = document.getElementById('saveChangesBtn');
        const toggleEditBtn = document.getElementById('toggleEditBtn');
        const exportPDFBtn = document.getElementById('exportPDFBtn');
        const saveBtn = document.getElementById('saveBtn');
        const presentationName = document.getElementById('presentationName');

        // Carregar apresenta√ß√£o
        async function loadPresentation() {
            try {
                const presentation = await presentationsService.getPresentation(projectId, presentationId);
                
                presentationName.textContent = presentation.presentationName || 'Apresenta√ß√£o';
                
                // Carregar customData se existir
                customData = presentation.customData || {};
                
                // Obter HTML original ou usar o salvo
                originalHTML = presentation.presentationHTML || presentation.html || '';
                
                // Renderizar apresenta√ß√£o
                renderPresentation(originalHTML);
                
                // Aguardar renderiza√ß√£o para aplicar customiza√ß√µes e ativar edi√ß√£o
                setTimeout(() => {
                // Aplicar customiza√ß√µes
                applyCustomizations();
                
                // Preparar elementos para edi√ß√£o (mas n√£o ativar ainda)
                prepareEditMode();
                
                // Iniciar em modo visualiza√ß√£o
                updateEditModeUI();
                
                // Reorganizar cards de an√∫ncios inicialmente
                setTimeout(() => {
                    reorganizeAdCards();
                }, 600);
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar apresenta√ß√£o:', error);
                presentationContainer.innerHTML = `
                    <div class="text-center py-20">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Erro ao carregar apresenta√ß√£o</h2>
                        <p class="text-gray-600">${error.message}</p>
                    </div>
                `;
            }
        }

        // Renderizar apresenta√ß√£o
        function renderPresentation(html) {
            presentationContainer.innerHTML = html;
            
            // Aguardar carregamento de fontes e imagens
            document.fonts.ready.then(() => {
                waitForImages().then(() => {
                    console.log('‚úÖ Apresenta√ß√£o renderizada');
                });
            });
        }

        // Aguardar carregamento de imagens
        function waitForImages() {
            const images = Array.from(document.querySelectorAll('img'));
            return Promise.all(
                images.map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise(resolve => {
                        img.onload = resolve;
                        img.onerror = resolve;
                    });
                })
            );
        }

        // Aplicar customiza√ß√µes salvas
        function applyCustomizations() {
            if (!customData || Object.keys(customData).length === 0) return;
            
            // Aguardar um pouco para garantir que todos os elementos foram renderizados
            setTimeout(() => {
                // Aplicar customiza√ß√µes de texto
                Object.keys(customData).forEach(editId => {
                    if (editId === 'adImages') return; // Pular objeto de imagens
                    
                    const element = document.querySelector(`[data-edit-id="${editId}"]`);
                    if (element) {
                        const customValue = customData[editId];
                        element.textContent = customValue;
                        element.setAttribute('data-original-value', customValue);
                        console.log(`‚úÖ Aplicada customiza√ß√£o para: ${editId} = ${customValue}`);
                    } else {
                        console.warn(`‚ö†Ô∏è Elemento n√£o encontrado: ${editId}`);
                    }
                });
                
                // Aplicar customiza√ß√µes de imagens de an√∫ncios
                if (customData.adImages && typeof customData.adImages === 'object') {
                    Object.keys(customData.adImages).forEach(adId => {
                        const thumbnail = document.querySelector(`[data-ad-image="${adId}"]`);
                        if (thumbnail) {
                            const img = thumbnail.querySelector('img');
                            if (img) {
                                img.src = customData.adImages[adId];
                                thumbnail.classList.remove('ranking-thumbnail-placeholder');
                                if (thumbnail.parentElement) {
                                    thumbnail.parentElement.classList.remove('ranking-card-placeholder');
                                }
                            } else {
                                // Se n√£o tem img, criar uma
                                thumbnail.innerHTML = `<img src="${customData.adImages[adId]}" alt="An√∫ncio" style="width:100%;height:100%;object-fit:cover;">`;
                                thumbnail.classList.remove('ranking-thumbnail-placeholder');
                                if (thumbnail.parentElement) {
                                    thumbnail.parentElement.classList.remove('ranking-card-placeholder');
                                }
                            }
                            console.log(`‚úÖ Aplicada imagem customizada para an√∫ncio: ${adId}`);
                        }
                    });
                }
            }, 500);
        }

        // Preparar elementos para edi√ß√£o
        function prepareEditMode() {
            // Encontrar todos os elementos edit√°veis
            const editables = [
                // Capa
                '.capa-title',
                '.capa-unidade',
                '.capa-periodo',
                
                // Resultados
                '.card-value',
                '.card-label',
                '.resultados-title',
                '.resultados-subtitle',
                
                // Ranking
                '.ranking-title',
                '.ranking-metrics-leads',
                '.ranking-metrics-cost',
                
                // Pr√≥ximos Passos
                '.proximos-title',
                '.proximos-subtitle',
                '.proximos-list li',
                
                // Obrigado
                '.obrigado-text'
            ];

            editables.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach((element, index) => {
                    // Criar ID √∫nico
                    const editId = `${selector.replace(/[.#\s]/g, '_')}_${index}`;
                    element.setAttribute('data-edit-id', editId);
                    element.classList.add('editable');
                    element.setAttribute('data-editable', 'true');
                    
                    // Event listeners
                    element.addEventListener('click', () => {
                        if (isEditMode && !element.hasAttribute('contenteditable')) {
                            startEditing(element, editId);
                        }
                    });
                    
                    element.addEventListener('blur', () => {
                        stopEditing(element, editId);
                    });
                });
            });
            
            // Adicionar m√©tricas de an√∫ncios como edit√°veis
            setTimeout(() => {
                const adMetrics = document.querySelectorAll('[data-ad-leads], [data-ad-cost]');
                adMetrics.forEach((element) => {
                    const adId = element.getAttribute('data-ad-leads') || element.getAttribute('data-ad-cost');
                    const metricType = element.classList.contains('ranking-metrics-leads') ? 'leads' : 'cost';
                    const editId = `ad_${adId}_${metricType}`;
                    
                    element.setAttribute('data-edit-id', editId);
                    element.classList.add('editable');
                    
                    element.addEventListener('click', () => {
                        if (isEditMode && !element.hasAttribute('contenteditable')) {
                            startEditing(element, editId);
                        }
                    });
                    
                    element.addEventListener('blur', () => {
                        stopEditing(element, editId);
                    });
                });
            }, 100);
            
            // Atualizar UI baseado no modo
            updateEditModeUI();
            setupAdImageEditing();
        }
        
        // Atualizar UI baseado no modo
        function updateEditModeUI() {
            const editables = document.querySelectorAll('.editable');
            editables.forEach(el => {
                if (isEditMode) {
                    el.style.cursor = 'text';
                } else {
                    el.style.cursor = 'default';
                    el.removeAttribute('contenteditable');
                }
            });
            
            // Mostrar/ocultar bot√µes de deletar an√∫ncios (n√£o mostrar no placeholder)
            const deleteButtons = document.querySelectorAll('.ranking-card-delete');
            deleteButtons.forEach(btn => {
                const card = btn.closest('.ranking-card');
                // N√£o mostrar bot√£o de deletar no placeholder
                if (card && card.classList.contains('ranking-card-placeholder')) {
                    btn.style.display = 'none';
                } else {
                    btn.style.display = isEditMode ? 'flex' : 'none';
                }
            });
        }
        
        // Configurar edi√ß√£o de imagens dos an√∫ncios
        function setupAdImageEditing() {
            const thumbnails = document.querySelectorAll('.ranking-thumbnail-editable');
            
            thumbnails.forEach(thumbnail => {
                const adId = thumbnail.getAttribute('data-ad-image');
                if (!adId) return;
                
                const fileInput = document.querySelector(`[data-ad-input="${adId}"]`);
                if (!fileInput) return;
                
                // Remover listeners antigos
                const newThumbnail = thumbnail.cloneNode(true);
                thumbnail.parentNode.replaceChild(newThumbnail, thumbnail);
                
                // Click para selecionar arquivo
                newThumbnail.addEventListener('click', (e) => {
                    if (isEditMode && !e.target.closest('.ranking-card-delete')) {
                        fileInput.click();
                    }
                });
                
                // Drag & Drop
                newThumbnail.addEventListener('dragover', (e) => {
                    if (isEditMode) {
                        e.preventDefault();
                        newThumbnail.style.border = '2px solid #9333EA';
                        newThumbnail.style.backgroundColor = 'rgba(147, 51, 234, 0.1)';
                    }
                });
                
                newThumbnail.addEventListener('dragleave', () => {
                    newThumbnail.style.border = '';
                    newThumbnail.style.backgroundColor = '';
                });
                
                newThumbnail.addEventListener('drop', (e) => {
                    if (isEditMode) {
                        e.preventDefault();
                        newThumbnail.style.border = '';
                        newThumbnail.style.backgroundColor = '';
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0 && files[0].type.startsWith('image/')) {
                            handleImageUpload(files[0], adId, newThumbnail);
                        }
                    }
                });
                
                // File input change
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleImageUpload(e.target.files[0], adId, newThumbnail);
                    }
                });
            });
            
            // Configurar bot√µes de deletar
            setupDeleteButtons();
        }
        
        // Processar upload de imagem
        function handleImageUpload(file, adId, thumbnail) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageUrl = e.target.result; // Base64
                
                // Atualizar imagem
                const existingImg = thumbnail.querySelector('img');
                if (existingImg) {
                    existingImg.src = imageUrl;
                } else {
                    const placeholder = thumbnail.querySelector('div');
                    if (placeholder) {
                        thumbnail.innerHTML = `<img src="${imageUrl}" alt="An√∫ncio" style="width:100%;height:100%;object-fit:cover;">`;
                    }
                }
                
                // Remover placeholder class se existir
                thumbnail.classList.remove('ranking-thumbnail-placeholder');
                if (thumbnail.parentElement) {
                    thumbnail.parentElement.classList.remove('ranking-card-placeholder');
                }
                
                // Salvar no customData
                if (!customData.adImages) customData.adImages = {};
                customData.adImages[adId] = imageUrl;
                
                // Se for placeholder_new, criar novo ID
                if (adId === 'placeholder_new') {
                    const newAdId = `ad_custom_${Date.now()}`;
                    thumbnail.setAttribute('data-ad-image', newAdId);
                    const img = thumbnail.querySelector('img');
                    if (img) img.setAttribute('data-ad-image', newAdId);
                    customData.adImages[newAdId] = imageUrl;
                    delete customData.adImages[adId];
                    
                    // Atualizar outros atributos
                    const card = thumbnail.closest('.ranking-card');
                    if (card) {
                        card.setAttribute('data-ad-id', newAdId);
                        const leadsEl = card.querySelector('[data-ad-leads]');
                        const costEl = card.querySelector('[data-ad-cost]');
                        if (leadsEl) leadsEl.setAttribute('data-ad-leads', newAdId);
                        if (costEl) costEl.setAttribute('data-ad-cost', newAdId);
                    }
                    const input = document.querySelector(`[data-ad-input="${adId}"]`);
                    if (input) input.setAttribute('data-ad-input', newAdId);
                }
                
                markAsChanged();
            };
            reader.readAsDataURL(file);
        }
        
        // Configurar bot√µes de deletar
        function setupDeleteButtons() {
            const deleteButtons = document.querySelectorAll('.ranking-card-delete');
            deleteButtons.forEach(btn => {
                // N√£o adicionar listener no placeholder
                const card = btn.closest('.ranking-card');
                if (card && card.classList.contains('ranking-card-placeholder')) {
                    return; // N√£o adicionar listener em placeholder
                }
                
                // Remover listeners antigos
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (isEditMode && confirm('Tem certeza que deseja remover este an√∫ncio?')) {
                        deleteAdCard(newBtn.closest('.ranking-card'));
                    }
                });
            });
        }
        
        // Deletar card de an√∫ncio
        function deleteAdCard(card) {
            const adId = card.getAttribute('data-ad-id');
            
            // Remover do customData
            if (customData.adImages && customData.adImages[adId]) {
                delete customData.adImages[adId];
            }
            
            // Remover card
            card.remove();
            
            // Reorganizar cards e mostrar placeholder se necess√°rio
            reorganizeAdCards();
            markAsChanged();
        }
        
        // Reorganizar cards ap√≥s deletar
        function reorganizeAdCards() {
            const grid = document.querySelector('.ranking-grid');
            if (!grid) return;
            
            const cards = Array.from(grid.querySelectorAll('.ranking-card:not(.ranking-card-placeholder)'));
            const placeholder = grid.querySelector('.ranking-card-placeholder');
            
            // Sempre manter 3 colunas para layout consistente
            grid.style.gridTemplateColumns = 'repeat(3, 1fr)';
            
            // Se tem menos de 3 cards e n√£o tem placeholder vis√≠vel, mostrar placeholder
            if (cards.length < 3 && placeholder) {
                placeholder.style.display = 'flex';
                // Esconder bot√£o de deletar do placeholder
                const placeholderDeleteBtn = placeholder.querySelector('.ranking-card-delete');
                if (placeholderDeleteBtn) {
                    placeholderDeleteBtn.style.display = 'none';
                }
            } else if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            // Centralizar cards se houver menos de 3
            if (cards.length === 1) {
                // Centralizar o √∫nico card
                grid.style.justifyItems = 'center';
                grid.style.maxWidth = '450px';
                grid.style.margin = '0 auto';
            } else if (cards.length === 2) {
                // Centralizar os 2 cards
                grid.style.justifyItems = 'center';
                grid.style.maxWidth = '950px';
                grid.style.margin = '0 auto';
            } else {
                grid.style.justifyItems = 'stretch';
                grid.style.maxWidth = '';
                grid.style.margin = '';
            }
            
            // Reconfigurar edi√ß√£o de imagens ap√≥s reorganizar
            if (isEditMode) {
                setTimeout(() => {
                    setupAdImageEditing();
                }, 100);
            }
        }

        // Iniciar edi√ß√£o
        function startEditing(element, editId) {
            element.setAttribute('contenteditable', 'true');
            element.focus();
            
            // Selecionar texto
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }

        // Parar edi√ß√£o
        function stopEditing(element, editId) {
            element.removeAttribute('contenteditable');
            
            // Salvar altera√ß√£o
            const newValue = element.textContent.trim();
            
            // Obter valor original (da primeira renderiza√ß√£o ou do customData)
            if (!element.hasAttribute('data-original-value')) {
                // Primeira vez editando - salvar valor original
                const originalText = element.textContent.trim();
                element.setAttribute('data-original-value', originalText);
            }
            
            const originalValue = element.getAttribute('data-original-value') || '';
            
            // Detectar qualquer altera√ß√£o (adicionar, remover, modificar - mesmo que fique vazio)
            if (newValue !== originalValue) {
                if (newValue === '') {
                    // Se ficou vazio, remover do customData mas manter a mudan√ßa registrada
                    delete customData[editId];
                    // Restaurar valor original visualmente
                    element.textContent = originalValue;
                    element.setAttribute('data-original-value', originalValue);
                } else {
                    customData[editId] = newValue;
                }
                markAsChanged();
                console.log(`üíæ Altera√ß√£o detectada: ${editId} (original: "${originalValue}" -> novo: "${newValue}")`);
            }
        }

        // Marcar como alterado
        function markAsChanged() {
            if (!hasUnsavedChanges) {
                hasUnsavedChanges = true;
                saveButtonContainer.classList.remove('hidden');
                saveBtn.classList.remove('hidden');
            }
        }

        // Salvar altera√ß√µes
        async function saveChanges() {
            if (!hasUnsavedChanges) {
                alert('Nenhuma altera√ß√£o para salvar');
                return;
            }

            saveChangesBtn.disabled = true;
            saveChangesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

            try {
                // Aplicar customiza√ß√µes de imagens no HTML antes de salvar
                applyImageCustomizationsToHTML();
                
                // Atualizar HTML com as altera√ß√µes
                const updatedHTML = presentationContainer.innerHTML;
                
                await presentationsService.updatePresentation(projectId, presentationId, {
                    customData: customData,
                    html: updatedHTML,
                    updatedAt: new Date().toISOString()
                });

                hasUnsavedChanges = false;
                saveButtonContainer.classList.add('hidden');
                saveBtn.classList.add('hidden');
                saveChangesBtn.disabled = false;
                saveChangesBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Altera√ß√µes';

                // Mostrar feedback
                showNotification('Altera√ß√µes salvas com sucesso!', 'success');

            } catch (error) {
                console.error('‚ùå Erro ao salvar:', error);
                saveChangesBtn.disabled = false;
                saveChangesBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Altera√ß√µes';
                showNotification('Erro ao salvar altera√ß√µes', 'error');
            }
        }

        // Mostrar notifica√ß√£o
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Toggle modo de edi√ß√£o
        toggleEditBtn.addEventListener('click', () => {
            isEditMode = !isEditMode;
            updateEditModeUI();
            
            // Reconfigurar edi√ß√£o de imagens quando mudar modo
            if (isEditMode) {
                setupAdImageEditing();
            }
            
            toggleEditBtn.innerHTML = isEditMode 
                ? '<i class="fas fa-eye"></i> Modo Visualiza√ß√£o'
                : '<i class="fas fa-edit"></i> Modo Edi√ß√£o';
        });

        // Salvar altera√ß√µes
        saveChangesBtn.addEventListener('click', saveChanges);
        saveBtn.addEventListener('click', saveChanges);

        // Exportar PDF
        exportPDFBtn.addEventListener('click', () => {
            // Aplicar customiza√ß√µes de imagens antes de exportar
            applyImageCustomizationsToHTML();
            
            // Remover classes e atributos de edi√ß√£o
            const editables = document.querySelectorAll('.editable');
            editables.forEach(el => {
                el.classList.remove('editable');
                el.removeAttribute('data-editable');
                el.removeAttribute('data-edit-id');
                el.removeAttribute('contenteditable');
                el.style.cursor = '';
                el.style.outline = '';
                el.style.backgroundColor = '';
            });
            
            // Remover bot√µes de deletar e inputs de arquivo
            document.querySelectorAll('.ranking-card-delete').forEach(btn => btn.remove());
            document.querySelectorAll('.ranking-image-input').forEach(input => input.remove());
            
            // Remover placeholder se existir
            const placeholder = document.querySelector('.ranking-card-placeholder');
            if (placeholder) placeholder.remove();
            
            // Obter HTML limpo (sem elementos de edi√ß√£o)
            const cleanHTML = presentationContainer.innerHTML;
            
            // Restaurar elementos para edi√ß√£o (caso o usu√°rio queira editar depois)
            setTimeout(() => {
                prepareEditMode();
            }, 100);
            
            // Salvar em sessionStorage para o apresentacao-print.html usar
            sessionStorage.setItem('presentationPrintPayload', JSON.stringify({
                html: cleanHTML
            }));
            
            // Abrir p√°gina de impress√£o
            window.open(`apresentacao-print.html?mode=session&auto=1`, '_blank');
        });
        
        // Aplicar customiza√ß√µes de imagens ao HTML antes de salvar
        function applyImageCustomizationsToHTML() {
            if (!customData.adImages) return;
            
            Object.keys(customData.adImages).forEach(adId => {
                const thumbnail = document.querySelector(`[data-ad-image="${adId}"]`);
                if (thumbnail) {
                    const img = thumbnail.querySelector('img');
                    if (img && customData.adImages[adId]) {
                        img.src = customData.adImages[adId];
                    }
                }
            });
        }

        // Carregar quando autenticado
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await loadPresentation();
            } else {
                window.location.href = '/login.html';
            }
        });
    </script>
    <script type="module">
        import { initSidebar } from './components/sidebar.js';
        initSidebar();
    </script>
</body>
</html>

